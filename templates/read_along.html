{% extends "base.html" %}
{% block title %}READ-ALONG MODE - NICOLAIS PDF2WAV{% endblock %}

{% block head %}
<!-- Add any enhanced styles here -->
<style>
/* Enhanced highlighting styles */
.text-segment {
    position: relative;
    transition: all 0.2s ease;
}

.text-segment.active {
    background: linear-gradient(
        to right,
        #9BF04C 0%,
        #9BF04C calc(var(--highlight-progress, 0) * 100%),
        rgba(155, 240, 76, 0.3) calc(var(--highlight-progress, 0) * 100%),
        rgba(155, 240, 76, 0.3) 100%
    );
}

.text-segment.pre-active {
    animation: pulse 0.5s ease-in-out;
}

.text-segment.upcoming {
    opacity: 0.8;
    border-bottom: 1px dashed rgba(155, 240, 76, 0.5);
}

.text-segment.low-confidence {
    border-bottom: 1px dotted #FBFE65;
}

.segment-type-technical {
    font-family: 'Courier New', monospace;
    background-color: rgba(64, 49, 141, 0.2);
}

.segment-type-emphasis {
    font-weight: bold;
}

.timing-quality-indicator {
    position: sticky;
    top: 0;
    background: rgba(0, 0, 0, 0.9);
    padding: 5px;
    text-align: center;
    font-size: 0.9em;
    z-index: 10;
    margin-bottom: 10px;
}

.timing-tooltip {
    background: rgba(0, 0, 0, 0.9);
    color: #50C8FC;
    padding: 5px 10px;
    border-radius: 3px;
    font-size: 0.8em;
    pointer-events: none;
    z-index: 1000;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Enhanced control styles */
#speedControl {
    background-color: #40318D;
    color: #FFFFFF;
    border: 2px solid #50C8FC;
    padding: 8px 15px;
    font-family: 'Courier Prime', monospace;
    font-weight: 700;
    margin-left: 10px;
}
</style>
{% endblock %}

{% block content %}
    <h1>‚óÜ READ-ALONG MODE ‚óÜ</h1>
    
    <div class="read-along-container">
        <div class="audio-controls-section">
            <h3>‚ô´ AUDIO PLAYBACK CONTROLS ‚ô´</h3>
            <div class="main-audio-player">
                <audio id="mainAudio" controls preload="metadata">
                    <source src="{{ url_for('serve_audio', filename=audio_filename) }}" type="audio/{{ 'mpeg' if audio_filename.endswith('.mp3') else 'wav' }}">
                    YOUR BROWSER DOES NOT SUPPORT AUDIO PLAYBACK.
                </audio>
            </div>
            
            <div class="playback-info">
                <div class="time-display">
                    <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
                </div>
                <div class="sync-controls">
                    <button id="toggleAutoScroll" class="control-btn">AUTO-SCROLL: ON</button>
                    <button id="resumeTracking" class="control-btn" style="display: none;">RESUME TRACKING</button>
                    <!-- Enhanced controls will be added here by JavaScript -->
                </div>
            </div>
        </div>

        <div class="text-display-section">
            <h3>üìÑ DOCUMENT TEXT</h3>
            <div id="textContainer" class="text-container">
                <p class="loading-text">LOADING ENHANCED TEXT SYNCHRONIZATION...</p>
            </div>
        </div>
    </div>

    <div class="rainbow-divider"></div>
    
    <div class="instructions">
        <h4><span class="icon">‚ñ∫</span>ENHANCED READ-ALONG FEATURES</h4>
        <ul>
            <li>TEXT HIGHLIGHTS SMOOTHLY AS AUDIO PLAYS</li>
            <li>CLICK ANY SENTENCE TO JUMP TO THAT POSITION</li>
            <li>ADJUST PLAYBACK SPEED (0.75x - 1.5x)</li>
            <li>TOGGLE BETWEEN SMOOTH AND INSTANT HIGHLIGHTING</li>
            <li>HOVER OVER TEXT TO SEE TIMING CONFIDENCE</li>
            <li>COLOR-CODED TEXT TYPES (TECHNICAL, EMPHASIS, ETC.)</li>
        </ul>
    </div>

    <div style="text-align: center; margin-top: 40px;">
        <a href="{{ url_for('index') }}" class="back-btn">
            << BACK TO CONVERTER
        </a>
    </div>

{% endblock %}

{% block scripts %}
<!-- Load the enhanced read-along JavaScript -->
<script src="{{ url_for('static', filename='js/enhanced_read_along.js') }}"></script>

<!-- Initialize the enhanced player -->
<script>
    // Configuration passed from Flask
    const READ_ALONG_CONFIG = {
        timingApiUrl: '{{ timing_api_url }}',
        audioFilename: '{{ audio_filename }}',
        baseFilename: '{{ base_filename }}',
        enableEnhancedFeatures: true
    };
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Initializing Enhanced Read-Along Player...');
        
        const audioElement = document.getElementById('mainAudio');
        
        // Check if enhanced player is available
        if (typeof EnhancedReadAlongPlayer !== 'undefined') {
            // Use enhanced player
            console.log('‚úÖ Using Enhanced Read-Along Player');
            window.readAlongPlayer = new EnhancedReadAlongPlayer(
                READ_ALONG_CONFIG.timingApiUrl, 
                audioElement
            );
        } else {
            // Fallback to basic player
            console.log('‚ö†Ô∏è Enhanced player not found, using basic player');
            
            // You can keep your original ReadAlongPlayer as fallback
            // Or show an error message
            document.getElementById('textContainer').innerHTML = `
                <p style="color: #FBFE65; text-align: center;">
                    ‚ùå Enhanced player not loaded<br>
                    Please check that enhanced_read_along.js is properly included
                </p>
            `;
        }
        
        // Debug information
        console.log('Read-along configuration:', READ_ALONG_CONFIG);
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (window.readAlongPlayer && window.readAlongPlayer.destroy) {
            window.readAlongPlayer.destroy();
        }
    });
</script>
{% endblock %}