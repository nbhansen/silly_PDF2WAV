{% extends "base.html" %}
{% block title %}CONVERSION COMPLETE - NICOLAIS PDF2WAV{% endblock %}
{% block content %}
    <h1>‚óÜ CONVERSION COMPLETE ‚óÜ</h1>
    <div class="success-message">
        *** AUDIO FILE GENERATION SUCCESSFUL ***
    </div>
    <div class="file-info">
        <h3>‚ñ† FILE INFORMATION</h3>
        <p><strong>ORIGINAL PDF:</strong> {{ original_filename }}</p>
        <p><strong>TTS ENGINE:</strong> {{ tts_engine }}</p>
        <p><strong>AUDIO FORMAT:</strong> MP3 (COMPRESSED FOR PLAYBACK)</p>
        {% if debug_info and debug_info.text_chunks_count %}
            <p><strong>CONTENT SECTIONS:</strong> {{ debug_info.text_chunks_count }} PARTS COMBINED</p>
        {% endif %}
        {% if debug_info and debug_info.timing_segments %}
            <p><strong>READ-ALONG SEGMENTS:</strong> {{ debug_info.timing_segments }} SYNCHRONIZED TEXT SECTIONS</p>
        {% endif %}
    </div>
    
    {% if combined_mp3_file %}
        <div class="audio-player-section">
            <h3>‚ô´ YOUR COMPLETE AUDIO FILE ‚ô´</h3>
            <div class="main-audio-player">
                <audio controls preload="metadata">
                    <source src="{{ url_for('serve_audio', filename=combined_mp3_file) }}" type="audio/mpeg">
                    YOUR BROWSER DOES NOT SUPPORT AUDIO PLAYBACK.
                </audio>
            </div>
            <div class="download-section">
                <a href="{{ url_for('serve_audio', filename=combined_mp3_file) }}" download="{{ combined_mp3_file }}" class="download-btn">
                    >> DOWNLOAD COMPLETE MP3 <<
                    <span class="size-info">OPTIMIZED FOR CAR AUDIO SYSTEMS</span>
                </a>
                
                {% if has_timing_data and base_filename %}
                <div class="read-along-section">
                    <a href="{{ url_for('read_along_view', filename=combined_mp3_file) }}" class="read-along-btn">
                        üìñ READ ALONG MODE
                        <span class="size-info">SYNCHRONIZED TEXT HIGHLIGHTING</span>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    {% elif audio_files and audio_files|length == 1 %}
        <div class="audio-player-section">
            <h3>‚ô´ YOUR AUDIO FILE ‚ô´</h3>
            <div class="main-audio-player">
                <audio controls preload="metadata">
                    <source src="{{ url_for('serve_audio', filename=audio_files[0]) }}" type="audio/{{ 'mpeg' if audio_files[0].endswith('.mp3') else 'wav' }}">
                    YOUR BROWSER DOES NOT SUPPORT AUDIO PLAYBACK.
                </audio>
            </div>
            <div class="download-section">
                <a href="{{ url_for('serve_audio', filename=audio_files[0]) }}" download="{{ audio_files[0] }}" class="download-btn">
                    >> DOWNLOAD AUDIO FILE <<
                </a>
                
                {% if has_timing_data and base_filename %}
                <div class="read-along-section">
                    <a href="{{ url_for('read_along_view', filename=audio_files[0]) }}" class="read-along-btn">
                        üìñ READ ALONG MODE
                        <span class="size-info">SYNCHRONIZED TEXT HIGHLIGHTING</span>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="fallback-info">
            <strong>NOTICE:</strong> MP3 COMPRESSION WAS NOT AVAILABLE, BUT YOUR AUDIO FILES WERE GENERATED SUCCESSFULLY.
            {% if audio_files %}
                <div style="margin-top: 20px;">
                    {% for audio_file in audio_files %}
                        <a href="{{ url_for('serve_audio', filename=audio_file) }}" download="{{ audio_file }}" class="download-btn" style="font-size: 0.9em; padding: 10px 20px; margin: 8px;">
                            >> DOWNLOAD PART {{ loop.index }} <<
                        </a>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    {% endif %}
    
    <div class="rainbow-divider"></div>
    <div class="instructions">
        <h4><span class="icon">‚ñ∫</span>SYSTEM USAGE INSTRUCTIONS</h4>
        <ul>
            <li>USE AUDIO CONTROLS ABOVE TO PLAY, PAUSE, AND ADJUST VOLUME</li>
            <li>CLICK "DOWNLOAD COMPLETE MP3" TO SAVE FILE TO YOUR DEVICE</li>
            <li>RIGHT-CLICK DOWNLOAD BUTTON TO SAVE TO PREFERRED LOCATION</li>
            {% if has_timing_data %}
            <li>CLICK "üìñ READ ALONG MODE" FOR SYNCHRONIZED TEXT HIGHLIGHTING</li>
            {% endif %}
            <li>AUDIO FILES ARE AUTOMATICALLY CLEANED FROM SERVER AFTER TIME</li>
        </ul>
    </div>
    {% if debug_info %}
        <div class="processing-info">
            <h4><span class="icon">‚óè</span>PROCESSING SUMMARY</h4>
            {% if debug_info.raw_text_length %}
                <div class="info-item">
                    <span class="info-label">TEXT EXTRACTED:</span> {{ "{:,}".format(debug_info.raw_text_length) }} CHARACTERS
                </div>
            {% endif %}
            {% if debug_info.page_range and debug_info.page_range != "full_document" %}
                <div class="info-item">
                    <span class="info-label">PAGE RANGE:</span> {{ debug_info.page_range.range_description if debug_info.page_range.range_description else debug_info.page_range }}
                </div>
            {% endif %}
            {% if debug_info.tts_engine %}
                <div class="info-item">
                    <span class="info-label">TTS ENGINE:</span> {{ debug_info.tts_engine }}
                </div>
            {% endif %}
            {% if debug_info.ffmpeg_available is defined %}
                <div class="info-item">
                    <span class="info-label">MP3 COMPRESSION:</span> {{ "‚úì AVAILABLE" if debug_info.ffmpeg_available else "‚úó NOT AVAILABLE" }}
                </div>
            {% endif %}
            {% if debug_info.ssml_enhancement %}
                <div class="info-item">
                    <span class="info-label">SSML ENHANCEMENT:</span> {{ debug_info.ssml_enhancement.upper() }}
                </div>
            {% endif %}
            {% if debug_info.timing_data_created %}
                <div class="info-item">
                    <span class="info-label">READ-ALONG DATA:</span> {{ "‚úì GENERATED" if debug_info.timing_data_created else "‚úó NOT GENERATED" }}
                </div>
            {% endif %}
            {% if debug_info.timing_segments %}
                <div class="info-item">
                    <span class="info-label">TIMING SEGMENTS:</span> {{ debug_info.timing_segments }} SYNCHRONIZED SECTIONS
                </div>
            {% endif %}
        </div>
    {% endif %}
    <div class="rainbow-divider"></div>
    <div style="text-align: center; margin-top: 40px;">
        <a href="{{ url_for('index') }}" class="back-btn">
            << CONVERT ANOTHER PDF
        </a>
    </div>
{% endblock %}
{% block scripts %}
<!-- Configuration data as JSON in a script tag -->
<script type="application/json" id="page-config">
{
    "originalFilename": "{{ original_filename }}",
    "hasTimingData": {{ 'true' if has_timing_data else 'false' }},
    "debugMode": {{ 'true' if debug_info else 'false' }}
}
</script>

<!-- Pure JavaScript with no Jinja syntax -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Read configuration from JSON script tag
        const configElement = document.getElementById('page-config');
        const pageConfig = JSON.parse(configElement.textContent);
        
        console.log('AUDIO CONVERSION COMPLETED FOR:', pageConfig.originalFilename);
        
        if (pageConfig.hasTimingData) {
            console.log('READ-ALONG MODE AVAILABLE');
        }
        
        // Auto-scroll to audio section
        const audioSection = document.querySelector('.audio-player-section');
        if (audioSection) {
            setTimeout(() => {
                audioSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
        }
        
        // Set up audio event listeners
        document.querySelectorAll('audio').forEach(audio => {
            audio.addEventListener('loadstart', function() {
                console.log('LOADING AUDIO:', this.src);
            });
            audio.addEventListener('canplay', function() {
                console.log('AUDIO READY TO PLAY:', this.src);
            });
            audio.addEventListener('error', function() {
                console.error('AUDIO LOADING ERROR:', this.src);
            });
        });
    });
</script>
{% endblock %}